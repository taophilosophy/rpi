# 总线、接口与协议

目前市面上出售的树莓派 5 扩展板，请确认其是否符合 HAT+ 标准。如果不符合那他只能一般是从 PCIe fpc（注意，树莓派提供的并不是 PCIe 接口，而是自己设计的 fpc 接口，所以必须通过转接器才能使用 PCIe）取电，根据树莓派排线规范，该接口只能提供最高 5V 1A 即 5W 的电力。同时树莓派 HAT+ 规范要求应该从 GPIO 取电。我们知道 M.2 只是物理接口，也就是说 M.2 本质上就是一个 mini 的 PCIe，无需任何芯片即可连接物理针脚。根据 M.2 规范及 PCIe 规范，M.2 最大为 3.3V 3A 即约 10W。也就是说，若要符合规范，必须额外取电 5V 1A。加起来是 5V 2A 即 10 W。

我们首先要区分三个东西，物理接口，总线协议和通道（协议）。从本质上来说，只有两个东西，因为总线协议=通道。

物理接口在理论上决定了上限和电气性能（比如能承载的电压电流和功率是多少，IP 等级多少，抗拉抗压能力是多少，接口尺寸规格是多少 X 多少），常见的有 M.2、U.2、SATA、USB（含 Type-C）、HDMI、DP、RJ45。在大多数情况下我们都是在讨论物理接口，但是严格来说这其实是没有意义也是不正确的。因为任何物理接口都是在理论上都是可以互相转换的（想想那些转换器）。比如物理接口 Type-C 就可以同时承载 USB2.0、USB3.0、DP、HDMI、雷电、TCP/IP、USB PD 等协议……物理接口和其承载的协议没有必然关系。所以 M.2 在理论上接口既可以接 NVMe 硬盘，也可以接 SATA 硬盘，也可以接显卡、声卡、主板上的 PCIe 能接什么他就能接什么，且无需任何驱动，可能需要 12 V 额外供电罢了。

总线协议（我们把直接连接 CPU 的通道叫做总线，总线本质上也是通道），现代 X86 计算机一般只有三个总线：USB、SATA、PCIe。现代 X86 计算机比如英特尔只有这三个。SATA 协议或 SATA 硬盘之所以慢是协议设计问题造成的，和 SATA 这个物理接口本身关系并不大，并且 SATA 协会已经摆烂了，他们认为与其设计出更多不兼容以往 SATA 设备的协议，去改造 SATA 这个总线，还不如让用户去用使用 PCIe 硬盘或者直接把 SATA 硬盘接到 PCIe 拉倒。SATA 目前也兼容了 PCIe 总线。

因为直连 CPU 的通道，我们叫总线协议，所以其他的通道就是普通协议。就叫通道或协议。对于现代处理器，只有 USB、SATA、PCIe 三个总线直连 CPU。其他大部分设备比如网卡、显卡、声卡、摄像头都是接入的 PCIe（但不一定是与 CPU 直连的 PCIe）。我们需要先来介绍一下 2010 以前的大部分 X86 计算机（即酷睿三代以前）的架构。CPU——>前端总线 FSB—>北桥—>PCI—>南桥—PCI>其他设备。当时还没有 PCIe。 北桥负责高速设备（比如内存、集显），南桥负责低速设备（网卡、键盘、鼠标、声卡、摄像头等）。南北桥直接通过 PCI 总线连接。在现代 x86 CPU 中，已经在主板上看不见北桥了，但是北桥并未真正消失，他只是被集成到了 CPU 而已，并且由若干 CPU 核心负责处理这些，PCIe 总线也从他们上面引出。我们所谓的直连 CPU 的 PCIe，本质上就是先前直连北桥的 PCI。我们知道现代 CPU 通过针脚接入主板、CPU 和主板之间的 PCIe，英特尔把他叫做 DMI。AMD 还是 PCIe。DMI 3.0x2=PCIe 3.0x2。也就是说，在主板上的设备，要么他是直连的 CPU，要么他是直连的主板通过 DMI 总线转接到 CPU 的。由于北桥被集成到了 CPU，所以看上去有两条路可以连接 CPU：①CPU—>PCIe（微处理器 PCIe）——>设备（任何设备），我们把这个叫做直连 CPU 的 PCIe；②CPU——>PCIe（DMI，芯片组/PCH PCIe）——>主板——>PCIe（或转成其他接口，如 SATA、USB、M.2）——>设备。因此理论上要获取最大速度，你需要使用 ①，但可能影响 CPU 及设备的稳定性。同时我们发现，PCIe 并不是无限多的，这是 CPU 规格决定的，一般是英特尔 CPU 可能只有 20 条 PCIe，如 PCIe 3.0x20，3.0 是 PCIe 的版本号，20 是条数。因此，DMI 即主板转接的上限也不是无穷大的，如果他在主板上放置了很多条 PCIe x16，由于 DMI 通道数的限制，也只是看上去好看，并不能达到预期效果（如果插满肯定是不符合预期的）。除了非直连 CPU 的设备，其他所有一切设备都是共享主板的 DMI 总线的。

一般来说，任何设备要转换，不仅需要在物理上转换（把线接到一起），也需要在软件（即驱动）层面上转换。比如所谓的 NVMe 转 USB，这是不标准的说法，真正正确的说法示例是 USB 3.1 Gen 2 到 PCIe Gen3 x2 桥接控制器。你的转换转的并不是 NVMe，而是把 PCIe 转到 USB。另外并不是说不用安驱动就证明里面没有芯片，因为大部分这种驱动都是内置于操作系统内部的。
其实严格意义上三者应该是分离的。所以 M.2 转 PCIe，只是用线把他们连起来，不需要芯片（故不需要驱动），而 M.2 要想支持 SATA，就涉及了协议转换，我们可以看到 M.2 的 SATA，物理接口是 M.2 的，但是由于 SATA 硬盘使用 SATA 协议，所以，必须要通过转换芯片才能连接，同样的，本质上也不是 SATA 转 M.2，而是 SATA 转 PCIe，即如 PCIe Gen3 x1 转 2xSATA 桥接控制器。

我们所说的 M.2 NVMe SSD 真正的名字应该是 PCIe 硬盘，或者说他是一种 PCIe 硬盘，NVMe 是基于 PCIe 的应用层协议，本质上仍然是 PCIe 协议，就像英特尔连接主板与 CPU 的通道的 DMI 在本质上也是 PCIe 一样。首先，任何 M.2 在物理上都完全等于 PCIe。无需任何芯片或电平转换。M.2 接口=mini PCIe，并且在历史上也的确如此。但是 M.2 没有 12V （U.2 接口支持，可以视为增强型的 M.2）。标准的 PCIe 接口同时供电 3.3V、12V，最大支持 75W。而标准的 M.2 最高支持 3.3V 3A，即 10W。

总线就是协议的一种，无非总线是公用通道而已。真正存在的东西只有两种，物理的接口和软件的协议。你别管他分多少层，那都没用。只要是软件就可以随便转（软件本质也是电压电流，电信号随便转），硬件也一样。世界不存在不能转的硬件。
